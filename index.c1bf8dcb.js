class e{#e;#t;#i;#s;#l;constructor(e,t,i){this.#e=e,this.#t=t,this.#i=i}get x(){return this.#t}get y(){return this.#i}get tile(){return this.#s}set tile(e){this.#s=e,null!=e&&(this.#s.x=this.#t,this.#s.y=this.#i)}get mergeTile(){return this.#l}set mergeTile(e){this.#l=e,null!=e&&(this.#l.x=this.#t,this.#l.y=this.#i)}canAccept(e){return null==this.tile||null==this.mergeTile&&this.tile.value===e.value}mergeTiles(){if(null!=this.tile&&null!=this.mergeTile)return this.tile.value=this.tile.value+this.mergeTile.value,this.mergeTile.remove(),this.mergeTile=null,this.tile.value}}class t{#r;#t;#i;#n;constructor(e,t=Math.random()>.1?2:4){this.#r=document.createElement("div"),this.#r.classList.add("game__tile"),e.append(this.#r),this.value=t}get value(){return this.#n}set value(e){this.#n=e,this.#r.textContent=e,this.#r.className=`game__tile game__tile--${e}`}get x(){return this.#t}set x(e){this.#t=e,this.#r.style.setProperty("--x",e)}get y(){return this.#i}set y(e){this.#i=e,this.#r.style.setProperty("--y",e)}remove(){this.#r.remove()}waitForTransition(e=!1){return new Promise(t=>{this.#r.addEventListener(e?"animationend":"transitionend",t,{once:!0})})}}class i{#a;#o;constructor(t,i=null){this.#o=t,t.style.setProperty("--grid-size",s),this.#a=this.#h(t).map((t,i)=>new e(t,i%s,Math.floor(i/s))),i&&this.#c(i)}get gridElement(){return this.#o}get cells(){return this.#a}get cellsByRow(){return this.#a.reduce((e,t)=>(e[t.y]=e[t.y]||[],e[t.y][t.x]=t,e),[])}get cellsByColumn(){return this.#a.reduce((e,t)=>(e[t.x]=e[t.x]||[],e[t.x][t.y]=t,e),[])}get #u(){return this.#a.filter(e=>null==e.tile)}randomEmptyCell(){let e=Math.floor(Math.random()*this.#u.length);return this.#u[e]}spawnTile(){let e=this.randomEmptyCell();if(!e)return;let i=new t(this.gridElement);return e.tile=i,i}clear(){this.#a.forEach(e=>{e.tile&&(e.tile.remove(),e.tile=null),e.mergeTile&&(e.mergeTile.remove(),e.mergeTile=null)})}#h(e){let t=[];for(let i=0;i<s*s;i++){let i=document.createElement("div");i.classList.add("game__cell"),t.push(i),e.append(i)}return t}#c(e){for(let i=0;i<e.length;i++)for(let s=0;s<e[i].length;s++){let l=e[i][s];if(l){let e=this.#a.find(e=>e.x===s&&e.y===i),r=new t(this.#o,l);e.tile=r}}}}const s=4;class l{#m;#d;#g;static GAME_STATUS={idle:"idle",playing:"playing",win:"win",lose:"lose"};static DIRECTIONS={UP:"up",DOWN:"down",LEFT:"left",RIGHT:"right"};constructor(e,t=null){this.#m=new i(e,t),this.#d=l.GAME_STATUS.idle,this.#g=0}get grid(){return this.#m}get score(){return this.#g}get status(){return this.#d}get isGameOver(){return this.#d===l.GAME_STATUS.lose}get isWin(){return this.#d===l.GAME_STATUS.win}start(){this.#d=l.GAME_STATUS.playing,this.spawnTiles(2)}restart(){this.#m.clear(),this.#d=l.GAME_STATUS.idle,this.#g=0}async tryMove(e){if(this.#d!==l.GAME_STATUS.playing)return;let{UP:t,DOWN:i,LEFT:s,RIGHT:r}=l.DIRECTIONS,[n,a]={[t]:[this.canMoveUp,this.moveUp],[i]:[this.canMoveDown,this.moveDown],[s]:[this.canMoveLeft,this.moveLeft],[r]:[this.canMoveRight,this.moveRight]}[e]||[];if(!n?.call(this))return!1;await a.call(this),this.mergeTiles();let[o]=this.spawnTiles(1);return this.canMoveUp()||this.canMoveDown()||this.canMoveLeft()||this.canMoveRight()||(this.#d=l.GAME_STATUS.lose,o&&await o.waitForTransition(!0)),!0}canMoveUp(){return this.#v(this.#m.cellsByColumn)}canMoveDown(){return this.#v(this.#m.cellsByColumn.map(e=>[...e].reverse()))}canMoveLeft(){return this.#v(this.#m.cellsByRow)}canMoveRight(){return this.#v(this.#m.cellsByRow.map(e=>[...e].reverse()))}moveUp(){return this.#T(this.#m.cellsByColumn)}moveDown(){return this.#T(this.#m.cellsByColumn.map(e=>[...e].reverse()))}moveLeft(){return this.#T(this.#m.cellsByRow)}moveRight(){return this.#T(this.#m.cellsByRow.map(e=>[...e].reverse()))}#v(e){return e.some(e=>e.some((t,i)=>0!==i&&null!=t.tile&&e[i-1].canAccept(t.tile)))}#T(e){return Promise.all(e.flatMap(e=>{let t=[];for(let i=1;i<e.length;i++){let s;let l=e[i];if(null!=l.tile){for(let t=i-1;t>=0;t--){let i=e[t];if(!i.canAccept(l.tile))break;s=i}null!=s&&(t.push(l.tile.waitForTransition()),null!=s.tile?s.mergeTile=l.tile:s.tile=l.tile,l.tile=null)}}return t}))}mergeTiles(){let e=0;this.#m.cells.forEach(t=>{let i=t.mergeTiles();i&&(e+=i,2048===i&&(this.#d=l.GAME_STATUS.win))}),this.#g+=e}spawnTiles(e=1){let t=[];for(let i=0;i<e;i++){let e=this.#m.spawnTile();t.push(e)}return t}}const r=document.querySelector(".game__field"),n=document.querySelector(".button"),a=document.querySelector(".game__score"),o=document.querySelector(".message--lose"),h=document.querySelector(".message--win"),c=document.querySelector(".message--start"),u=new l(r),{DIRECTIONS:m}=l;let d=null,g=null;function v(e){e.preventDefault();let t=e.changedTouches[0];d=t.clientX,g=t.clientY}async function T(e){let t;e.preventDefault();let i=e.changedTouches[0],s=i.clientX-d,l=i.clientY-g;30>Math.abs(s)&&30>Math.abs(l)||(t=Math.abs(s)>Math.abs(l)?s>0?m.RIGHT:m.LEFT:l>0?m.DOWN:m.UP,await y(t))}async function y(e){if(await u.tryMove(e)){if(w(),u.isWin){h.classList.remove("hidden"),f();return}if(u.isGameOver){o.classList.remove("hidden"),f();return}}p()}async function E(e){let t={ArrowUp:m.UP,ArrowDown:m.DOWN,ArrowLeft:m.LEFT,ArrowRight:m.RIGHT}[e.key];if(!t){p();return}await y(t)}function p(){window.addEventListener("keydown",E,{once:!0})}function w(){a.textContent=u.score}function f(){r.removeEventListener("touchstart",v),r.removeEventListener("touchend",T)}n.addEventListener("click",function(){u.status===l.GAME_STATUS.idle?(n.classList.remove("button--start"),n.classList.add("button--restart"),n.textContent="Restart",c.classList.add("hidden"),u.start(),p(),r.addEventListener("touchstart",v),r.addEventListener("touchend",T)):(h.classList.add("hidden"),o.classList.add("hidden"),c.classList.remove("hidden"),n.classList.remove("button--restart"),n.classList.add("button--start"),n.textContent="Start",u.restart(),w(),f())});
//# sourceMappingURL=index.c1bf8dcb.js.map
